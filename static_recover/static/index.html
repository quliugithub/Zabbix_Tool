<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zabbix Agent æ§åˆ¶å°</title>
  <!-- å¼•å…¥åˆ†ç¦»çš„ CSS æ–‡ä»¶ -->
  <link rel="stylesheet" href="static/css/style.css">
  <style>
    /* === é’ˆå¯¹æ–°éœ€æ±‚çš„å†…è”æ ·å¼è¦†ç›– (å»ºè®®åç»­ç§»å…¥ style.css) === */

    /* åº•éƒ¨æ“ä½œåŒºåŸŸå®¹å™¨ - ç±»ä¼¼ Card Footer */
    .bottom-action-area {
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid var(--border);
    }

    /* åŒºåŸŸæ ‡é¢˜ */
    .action-section-title {
        font-size: 12px;
        font-weight: 700;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* æ¨¡å¼é€‰æ‹©ç½‘æ ¼ - 3åˆ—ç­‰å®½ */
    .mode-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 24px;
    }

    /* å•ä¸ªæ¨¡å¼å¡ç‰‡ */
    .mode-card {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: flex-start; /* å·¦å¯¹é½æ›´æ˜“è¯» */
        justify-content: center;
        padding: 16px;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        height: 100%; /* ç¡®ä¿é«˜åº¦ä¸€è‡´ */
        box-sizing: border-box;
    }

    .mode-card:hover {
        border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        transform: translateY(-2px);
    }

    /* é€‰ä¸­çŠ¶æ€ */
    .mode-card:has(input:checked) {
        border-color: var(--primary);
        background: #eff6ff; /* var(--primary-light) very light */
        box-shadow: 0 0 0 1px var(--primary);
    }

    /* éšè—åŸç”Ÿ Radio */
    .mode-card input[type="radio"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }

    /* é€‰ä¸­æ—¶çš„å¯¹å‹¾å›¾æ ‡ */
    .mode-card:has(input:checked)::after {
        content: 'âœ”';
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 14px;
        color: var(--primary);
        font-weight: bold;
    }

    /* å¡ç‰‡ä¸»æ ‡é¢˜ */
    .mode-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 6px;
        display: block;
    }

    .mode-card:has(input:checked) .mode-title {
        color: var(--primary);
    }

    /* å¡ç‰‡å‰¯æ ‡é¢˜/æè¿° */
    .mode-desc {
        font-size: 12px;
        color: var(--text-secondary);
        line-height: 1.4;
    }
    .mode-card:has(input:checked) .mode-desc {
        color: #60a5fa; /* Lighter blue */
    }

    /* åº•éƒ¨å·¥å…·æ ï¼šå³ä¾§æŒ‰é’® */
    .action-toolbar {
        display: flex;
        align-items: center;
        justify-content: flex-end; /* é å³å¯¹é½ */
        gap: 16px;
        flex-wrap: wrap;
    }

    /* æŒ‰é’®ç»„ */
    .btn-group {
        display: flex;
        gap: 12px;
        align-items: center;
    }
  </style>
</head>
<body>

<!-- Toast å®¹å™¨ -->
<div class="toast-container" id="toastContainer"></div>

<!-- å…¨å±€åˆå§‹åŒ– Loading -->
<div id="global-loading"><div class="spinner"></div></div>

<div class="container">
  <header class="main-header">
    <h1>Zabbix Agent æ§åˆ¶å°</h1>
    <span class="status-badge">System Ready</span>
  </header>

  <div class="tabs">
    <div class="tab-btn active" data-tab="dashboard">ä»ªè¡¨ç›˜</div>
    <div class="tab-btn" data-tab="install">å®‰è£… Agent</div>
    <div class="tab-btn" data-tab="batch">æ‰¹é‡å®‰è£…</div>
    <div class="tab-btn" data-tab="tmpl">æ¨¡æ¿ç®¡ç†</div>
    <div class="tab-btn" data-tab="group">ç¾¤ç»„ç®¡ç†</div>
    <div class="tab-btn" data-tab="bind">æ¨¡æ¿ç»‘å®š</div>
    <div class="tab-btn" data-tab="uninstall">å¸è½½/åˆ é™¤</div>
    <div class="tab-btn" data-tab="config" style="margin-left: auto;">âš™ï¸ è®¾ç½®</div>
  </div>

  <!-- 1. ä»ªè¡¨ç›˜ -->
  <div id="dashboard" class="tab active">
    <div class="dashboard-grid">
      <div class="stat-card">
        <div class="stat-label">å·²ç¼“å­˜æ¨¡æ¿</div>
        <div class="stat-val" id="stat-tmpl-count">0</div>
        <button class="secondary" onclick="loadTemplates(true)" style="font-size:11px; padding:4px 8px;">åˆ·æ–°</button>
      </div>
      <div class="stat-card">
        <div class="stat-label">å·²ç¼“å­˜ç¾¤ç»„</div>
        <div class="stat-val" id="stat-group-count">0</div>
        <button class="secondary" onclick="loadGroups(true)" style="font-size:11px; padding:4px 8px;">åˆ·æ–°</button>
      </div>
      <div class="stat-card">
        <div class="stat-label">é…ç½®çŠ¶æ€</div>
        <div class="stat-val" id="stat-config" style="font-size:16px; line-height:38px;">æ£€æµ‹ä¸­...</div>
        <div class="stat-label" style="font-size:11px;">Server è¿æ¥æ€§</div>
      </div>
    </div>
    <fieldset>
      <legend>å¿«é€Ÿæ“ä½œ</legend>
      <div style="display:flex; gap:12px;">
         <button onclick="switchTab('install')">â• æ–°å¢ä¸»æœº</button>
         <button onclick="switchTab('batch')" class="secondary">ğŸ“‚ æ‰¹é‡å¯¼å…¥</button>
         <button onclick="switchTab('config')" class="secondary">âš™ï¸ ä¿®æ”¹é…ç½®</button>
      </div>
    </fieldset>
  </div>

  <!-- 2. å®‰è£… Agent -->
  <div id="install" class="tab">
    <fieldset>
      <legend>ä¸»æœºä¿¡æ¯ä¸é…ç½®</legend>
      <div class="grid-2">
        <!-- åŸºç¡€ä¿¡æ¯ -->
        <div><label>ä¸»æœºåï¼ˆç•™ç©ºåˆ™è‡ªåŠ¨è¯»å–ï¼‰</label><input id="host" placeholder="ä¾‹å¦‚ï¼šsrv-01ï¼Œç•™ç©ºè‡ªåŠ¨ hostname" /></div>
        <div><label>IP åœ°å€ <span style="color:red">*</span></label><input id="ip" placeholder="ä¾‹å¦‚ï¼š10.0.0.1" /></div>
        <div><label>å¯è§åç§° (Visible Name)</label><input id="visible_name" placeholder="Zabbix æ˜¾ç¤ºåˆ«å" /></div>
        <div><label>ç³»ç»Ÿç±»å‹</label>
           <select id="os"><option value="linux">Linux</option><option value="windows">Windows</option></select>
        </div>
        <div><label>SSH ç”¨æˆ·</label><input id="ssh_user" placeholder="root" /></div>
        <div>
            <label>SSH å¯†ç </label>
            <div class="input-wrapper">
                <input id="ssh_password" type="password" />
                <span class="eye-icon" onclick="togglePassword('ssh_password')">ğŸ‘ï¸</span>
            </div>
        </div>
        <div><label>SSH ç«¯å£</label><input id="ssh_port" value="22" type="number" /></div>
        <div><label>Agent ç«¯å£</label><input id="port" value="10050" type="number" /></div>
        <div><label>JMX ç«¯å£</label><input id="jmx_port" value="10052" type="number" /></div>
        
        <div><label>Webç›‘æ§URL (å¯é€‰)</label><input id="web_url" placeholder="http://example.com/health" /></div>


        <!-- å…³è”ä¿¡æ¯ -->
        <div>
          <label>å…³è”æ¨¡æ¿</label>
          <div class="dropdown">
            <button type="button" onclick="toggleDropdown('tmplMenu')">é€‰æ‹©æ¨¡æ¿ (å¯æœç´¢)</button>
            <div class="dropdown-menu" id="tmplMenu">
              <input id="tmplFilter" placeholder="æœç´¢æ¨¡æ¿..." style="margin-bottom:8px;" oninput="debouncedFilterTemplates()" />
              <div id="tmplOptions"></div>
              <button class="secondary" style="width:100%; margin-top:6px;" onclick="clearTemplates()">æ¸…ç©º</button>
            </div>
          </div>
          <div id="tmplSelected" class="selected-tags"></div>
        </div>

        <div>
          <label>å…³è”ç¾¤ç»„</label>
          <div class="dropdown">
            <button type="button" onclick="toggleDropdown('groupMenu')">é€‰æ‹©ç¾¤ç»„ (å¯æœç´¢)</button>
            <div class="dropdown-menu" id="groupMenu">
              <input id="groupFilter" placeholder="æœç´¢ç¾¤ç»„..." style="margin-bottom:8px;" oninput="debouncedFilterGroups()" />
              <div id="groupOptions"></div>
              <button class="secondary" style="width:100%; margin-top:6px;" onclick="clearGroups()">æ¸…ç©º</button>
            </div>
          </div>
          <div id="groupSelected" class="selected-tags"></div>
        </div>

        <div>
          <label>å…³è” Proxy (å¯é€‰)</label>
          <div class="dropdown">
            <button type="button" onclick="toggleDropdown('proxyMenu')">é€‰æ‹© Proxy (å¯æœç´¢)</button>
            <div class="dropdown-menu" id="proxyMenu">
              <input id="proxyFilter" placeholder="æœç´¢ Proxy..." style="margin-bottom:8px;" oninput="debouncedFilterProxies()" />
              <div id="proxyOptions"></div>
              <button class="secondary" style="width:100%; margin-top:6px;" onclick="clearProxy()">æ¸…ç©º</button>
            </div>
          </div>
          <div id="proxySelected" class="selected-tags"></div>
        </div>
      </div>

      <!-- åº•éƒ¨æ“ä½œåŒºï¼šæ‰§è¡Œæ¨¡å¼ + æŒ‰é’® (é‡æ„ä¼˜åŒ–ç‰ˆ) -->
      <div class="bottom-action-area">
          <div class="action-section-title">
             ğŸ› ï¸ ä»»åŠ¡æ‰§è¡Œæ¨¡å¼
          </div>

          <!-- æ¨¡å¼é€‰æ‹© Grid -->
          <div class="mode-grid">
              <label class="mode-card">
                  <input type="radio" name="install_mode" value="full" checked onchange="onModeChange()">
                  <span class="mode-title">æ ‡å‡†å®‰è£…</span>
                  <span class="mode-desc">éƒ¨ç½² Agent å¹¶æ³¨å†Œåˆ° Serverï¼Œå…¨æµç¨‹è‡ªåŠ¨åŒ–ã€‚</span>
              </label>

              <label class="mode-card">
                  <input type="radio" name="install_mode" value="agent_only" onchange="onModeChange()">
                  <span class="mode-title">ä»…éƒ¨ç½²è½¯ä»¶</span>
                  <span class="mode-desc">åªå®‰è£… Agent è½¯ä»¶ï¼Œä¸è¿›è¡Œ Server æ³¨å†Œã€‚</span>
              </label>

              <label class="mode-card">
                  <input type="radio" name="install_mode" value="register_only" onchange="onModeChange()">
                  <span class="mode-title">ä»…æ³¨å†Œé…ç½®</span>
                  <span class="mode-desc">è·³è¿‡è½¯ä»¶å®‰è£…ï¼Œä»…ä¿®æ”¹é…ç½®å¹¶æ³¨å†Œä¸»æœºã€‚</span>
              </label>
          </div>

          <!-- åº•éƒ¨å·¥å…·æ  -->
          <div class="action-toolbar">
              <div class="btn-group">
                  <button class="secondary" onclick="showInstallLog()">ğŸ“œ æŸ¥çœ‹æ—¥å¿—</button>
                  <button onclick="install(this)" style="padding:10px 32px; font-weight:600;">ğŸš€ å¼€å§‹æ‰§è¡Œ</button>
              </div>
          </div>
      </div>
    </fieldset>
  </div>

  <!-- 3. æ‰¹é‡å®‰è£… -->
  <div id="batch" class="tab">
    <fieldset>
      <legend>æ‰¹é‡å®‰è£…ï¼ˆExcel å¯¼å…¥ä¸»æœºï¼Œæ¨¡æ¿/ç»„/Proxy åœ¨ç•Œé¢é€‰æ‹©ï¼‰</legend>
      <div style="display:flex; flex-direction:column; gap:12px;">
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <input type="file" id="batchFile" accept=".xlsx,.xls,.csv" style="width:auto; border:none;" />
          <button onclick="uploadBatch(this)">ğŸ“¤ ä¸Šä¼ å¹¶é¢„è§ˆ</button>
          <div id="batchInfo" style="font-weight:600; color:var(--primary);"></div>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <label style="font-weight:600;">å†å²æ‰¹æ¬¡</label>
          <select id="batchHistory" onchange="loadBatchById(this.value)" style="min-width:220px;"></select>
          <button class="secondary" onclick="refreshBatchList()">ğŸ”„ åˆ·æ–°æ‰¹æ¬¡</button>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <button onclick="runBatch('install', this)">ğŸš€ æ‰¹é‡å®‰è£…</button>
          <button class="secondary" onclick="runBatch('uninstall', this)">ğŸ—‘ï¸ æ‰¹é‡å¸è½½</button>
          <span style="color:#64748b; font-size:12px;">ä¼šä½¿ç”¨å½“å‰é€‰æ‹©çš„æ¨¡æ¿/ç¾¤ç»„/Proxy/JMXç«¯å£/Webç›‘æ§é…ç½®</span>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
        <button class="secondary" onclick="downloadBatchTemplate()">ğŸ“¥ ä¸‹è½½æ¨¡æ¿æ–‡ä»¶</button>
        <span style="color:#64748b; font-size:12px;">å¯ç›´æ¥åœ¨è¡¨æ ¼å†…ç¼–è¾‘å„å­—æ®µ</span>
      </div>
      <div style="margin-top:12px; overflow-x:auto;">
        <table id="batchTable" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="width:40px;">é€‰</th>
              <th>ä¸»æœºå</th><th>IP</th><th>Env</th><th>SSHç”¨æˆ·</th><th>SSHç«¯å£</th><th>Agentç«¯å£</th><th>JMXç«¯å£</th><th>Proxy</th><th>æ¨¡æ¿IDs</th><th>ç¾¤ç»„IDs</th><th>çŠ¶æ€</th><th>æ—¥å¿—</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </fieldset>
  </div>

  <!-- 4. æ¨¡æ¿åˆ—è¡¨ -->
  <div id="tmpl" class="tab">
    <fieldset>
      <legend>æ¨¡æ¿æŸ¥è¯¢</legend>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
        <input id="tmplSearch" placeholder="è¾“å…¥åç§°æˆ– ID..." style="width: 300px;" oninput="debouncedSearchTmpl()" />
        <button onclick="loadTemplates(true, this)">ğŸ”„ åˆ·æ–°æ•°æ®</button>
      </div>
      <div style="max-height:600px; overflow-y:auto;">
          <table id="tmplTable" style="display:none;"><thead></thead><tbody></tbody></table>
      </div>
    </fieldset>
  </div>

  <!-- 5. ç¾¤ç»„åˆ—è¡¨ -->
  <div id="group" class="tab">
    <fieldset>
      <legend>ç¾¤ç»„æŸ¥è¯¢</legend>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
        <input id="groupSearch" placeholder="è¾“å…¥åç§°æˆ– ID..." style="width: 300px;" oninput="debouncedSearchGroup()" />
        <button onclick="loadGroups(true, this)">ğŸ”„ åˆ·æ–°æ•°æ®</button>
      </div>
      <div style="max-height:600px; overflow-y:auto;">
          <table id="groupTable" style="display:none;"><thead></thead><tbody></tbody></table>
      </div>
    </fieldset>
  </div>

  <!-- 6. æ¨¡æ¿ç»‘å®š -->
  <div id="bind" class="tab">
    <fieldset>
      <legend>å·²æœ‰ä¸»æœºç»‘å®š/è§£ç»‘æ¨¡æ¿</legend>
      <div class="grid-2">
          <div><label>ä¸»æœº IP</label><input id="tpl_ip" /></div>
          <div><label>æ¨¡æ¿ ID (é€—å·åˆ†éš”)</label><input id="tpl_ids" /></div>
          <div>
            <label>æ“ä½œç±»å‹</label>
            <select id="tpl_action"><option value="bind">ç»‘å®š (Link)</option><option value="unbind">è§£ç»‘ (Unlink)</option></select>
          </div>
      </div>
      <button onclick="tplAction(this)" style="margin-top:16px;">æ‰§è¡Œæ“ä½œ</button>
    </fieldset>
  </div>

  <!-- 7. å¸è½½/åˆ é™¤ -->
  <div id="uninstall" class="tab">
    <fieldset style="border-color:#fca5a5; background:#fef2f2;">
      <legend style="color:#b91c1c;">âš ï¸ å±é™©æ“ä½œåŒº</legend>

      <div style="margin-bottom:24px;">
          <h4 style="margin:0 0 8px 0; color:#b91c1c;">Agent å¸è½½</h4>
          <div class="grid-2">
            <div><label>IP åœ°å€</label><input id="un_ip" /></div>
            <div><label>SSH ç”¨æˆ·</label><input id="un_ssh_user" value="root" /></div>
            <div>
                <label>SSH å¯†ç </label>
                <div class="input-wrapper">
                    <input id="un_ssh_password" type="password" />
                    <span class="eye-icon" onclick="togglePassword('un_ssh_password')">ğŸ‘ï¸</span>
                </div>
            </div>
            <div><label>SSH ç«¯å£</label><input id="un_ssh_port" value="22" type="number" /></div>
          </div>
          <button class="danger" onclick="uninstall(this)" style="margin-top:12px;">ğŸ—‘ï¸ å¸è½½ Agent</button>
      </div>

      <hr style="border:0; border-top:1px dashed #fca5a5; margin:20px 0;">

      <div class="grid-2">
        <div>
            <label>åˆ é™¤æ¨¡æ¿ (ID)</label>
            <div style="display:flex; gap:8px;">
                <input id="del_tpl" placeholder="Template ID" />
                <button class="danger" onclick="deleteTemplate(this)">åˆ é™¤</button>
            </div>
        </div>
        <div>
            <label>åˆ é™¤ç¾¤ç»„ (ID)</label>
            <div style="display:flex; gap:8px;">
                <input id="del_group" placeholder="Group ID" />
                <button class="danger" onclick="deleteGroup(this)">åˆ é™¤</button>
            </div>
        </div>
      </div>
    </fieldset>
  </div>

  <!-- 8. é…ç½® -->
  <div id="config" class="tab">
    <fieldset>
      <legend>API ä¸ç¯å¢ƒè®¾ç½®</legend>
      <div class="grid-2">
        <div>
          <label>API åœ°å€</label>
          <input id="cfg_api_base" placeholder="http://192.168.1.100/zabbix/api_jsonrpc.php" />
        </div>
        <div><label>Zabbix Server Host</label><input id="cfg_server_host" /></div>
        <div><label>ç®¡ç†å‘˜è´¦å·</label><input id="cfg_user" /></div>
        <div>
            <label>ç®¡ç†å‘˜å¯†ç </label>
            <div class="input-wrapper">
                <input id="cfg_password" type="password" />
                <span class="eye-icon" onclick="togglePassword('cfg_password')">ğŸ‘ï¸</span>
            </div>
        </div>
        <div><label>é»˜è®¤æ¨¡æ¿ID</label><input id="cfg_default_template" /></div>
        <div><label>é»˜è®¤ç¾¤ç»„ID</label><input id="cfg_default_group" /></div>
        <div><label>Zabbix ç‰ˆæœ¬</label><input id="cfg_version" placeholder="6.4 / 6.0 / 5.0" /></div>
        
        <div><label>è¿œç«¯ Agent åŒ… URL (å¯é€‰)</label><input id="cfg_agent_tgz" /></div>
        <div><label>æœ¬åœ° Agent åŒ…è·¯å¾„</label><input id="local_agent_path" /></div>
      </div>
      <div style="margin-top:20px;">
        <button onclick="saveConfig(this)">ğŸ’¾ ä¿å­˜é…ç½®</button>
        <button class="secondary" onclick="loadConfig(true)">ğŸ”„ é‡ç½®</button>
      </div>
    </fieldset>
  </div>
</div>

<!-- æ–°ç‰ˆæ—¥å¿—å¼¹çª— (Large) -->
<div class="modal-backdrop" id="logModal">
  <div class="modal large">
    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <span style="font-size:18px;">ğŸ“œ æ‰§è¡Œæ—¥å¿—</span>
            <span class="status-badge" id="logCountBadge" style="display:none; font-weight:normal;">0</span>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
            <button class="secondary" onclick="loadLogList()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            <button class="secondary" onclick="closeModal('logModal')">âŒ å…³é—­</button>
        </div>
    </header>
    <div class="log-panel">
        <div class="log-list" id="logList">
            <!-- JS å¡«å…… -->
        </div>
        <div class="log-detail-wrapper">
            <pre id="logContent">è¯·ç‚¹å‡»å·¦ä¾§ä»»åŠ¡æŸ¥çœ‹è¯¦ç»†æ—¥å¿—...</pre>
        </div>
    </div>
  </div>
</div>

<!-- ç»“æœè¯¦æƒ…å¼¹çª— -->
<div class="modal-backdrop" id="resultModal">
  <div class="modal">
    <header><span>è¯¦ç»†ä¿¡æ¯</span><button class="secondary" onclick="closeModal('resultModal')">å…³é—­</button></header>
    <pre id="resultContent"></pre>
  </div>
</div>

<!-- å¼•å…¥åˆ†ç¦»çš„ JS æ–‡ä»¶ -->
<script src="static/js/app.js"></script>
</body>
</html>
